"use strict";(self.webpackChunkotp_docs=self.webpackChunkotp_docs||[]).push([[605],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>h});var a=n(7294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function p(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var s=a.createContext({}),l=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},c=function(e){var t=l(e.components);return a.createElement(s.Provider,{value:t},e.children)},u="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,r=e.originalType,s=e.parentName,c=p(e,["components","mdxType","originalType","parentName"]),u=l(n),m=o,h=u["".concat(s,".").concat(m)]||u[m]||d[m]||r;return n?a.createElement(h,i(i({ref:t},c),{},{components:n})):a.createElement(h,i({ref:t},c))}));function h(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=n.length,i=new Array(r);i[0]=m;var p={};for(var s in t)hasOwnProperty.call(t,s)&&(p[s]=t[s]);p.originalType=e,p[u]="string"==typeof e?e:o,i[1]=p;for(var l=2;l<r;l++)i[l]=n[l];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},187:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>d,frontMatter:()=>r,metadata:()=>p,toc:()=>l});var a=n(7462),o=(n(7294),n(3905));const r={},i="ArgoCD concepts",p={unversionedId:"guides/technical-explanations/argocd-concepts",id:"guides/technical-explanations/argocd-concepts",title:"ArgoCD concepts",description:"For a complete introduction to ArgoCD concepts, visit ArgoCD documentation website, and OpenShift GitOps documentation for product-specific information. This page shows the relevant concepts to the pattern.",source:"@site/docs/03-guides/01-technical-explanations/01-argocd-concepts.md",sourceDirName:"03-guides/01-technical-explanations",slug:"/guides/technical-explanations/argocd-concepts",permalink:"/guides/technical-explanations/argocd-concepts",draft:!1,editUrl:"https://github.com/one-touch-provisioning/otp-docs/docs/03-guides/01-technical-explanations/01-argocd-concepts.md",tags:[],version:"current",sidebarPosition:1,frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Guides",permalink:"/category/guides"},next:{title:"Git repositories",permalink:"/guides/technical-explanations/git-repositories"}},s={},l=[{value:"Application sync waves",id:"application-sync-waves",level:2},{value:"Application template source",id:"application-template-source",level:2},{value:"AppProject",id:"appproject",level:2},{value:"ApplicationSet",id:"applicationset",level:2}],c={toc:l},u="wrapper";function d(e){let{components:t,...n}=e;return(0,o.kt)(u,(0,a.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"argocd-concepts"},"ArgoCD concepts"),(0,o.kt)("p",null,"For a complete introduction to ArgoCD concepts, visit ",(0,o.kt)("a",{parentName:"p",href:"https://argo-cd.readthedocs.io/en/stable/"},"ArgoCD documentation website"),", and ",(0,o.kt)("a",{parentName:"p",href:"https://docs.openshift.com/container-platform/4.12/cicd/gitops/gitops-release-notes.html"},"OpenShift GitOps documentation")," for product-specific information. This page shows the relevant concepts to the pattern."),(0,o.kt)("h2",{id:"application-sync-waves"},"Application sync waves"),(0,o.kt)("p",null,"ArgoCD Application ",(0,o.kt)("a",{parentName:"p",href:"https://argo-cd.readthedocs.io/en/stable/user-guide/sync-waves/"},"sync waves")," concept is an annotation that specifies the order of deployment of resources. Sync waves are arbitrary numbers. Lower numbered resources get deployed first. ArgoCD sync waves only work within a single ArgoCD application context. To order the deployments of multiple ArgoCD applications, an overarching Application must be used to form a larger application context. This is the basis for the ",(0,o.kt)("a",{parentName:"p",href:"https://argo-cd.readthedocs.io/en/stable/operator-manual/cluster-bootstrapping/"},"App-of-Apps pattern"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: argoproj.io/v1alpha1\n// highlight-next-line\nkind: Application\nmetadata:\n\xa0\xa0name: cluster-pool\n  // highlight-start\n\xa0\xa0annotations:\n\xa0\xa0\xa0\xa0argocd.argoproj.io/sync-wave: "310"\n  // highlight-end\n\xa0\xa0labels:\n\xa0\xa0\xa0\xa0gitops.tier.layer: clusters\nspec:\n  ...\n')),(0,o.kt)("p",null,"In this pattern, we have an overarching ",(0,o.kt)("inlineCode",{parentName:"p"},"bootstrap")," app, that deploys multiple ArgoCD applications: ",(0,o.kt)("inlineCode",{parentName:"p"},"infra"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"services"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"policies"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"clusters"),", and ",(0,o.kt)("inlineCode",{parentName:"p"},"apps"),"."),(0,o.kt)("h2",{id:"application-template-source"},"Application template source"),(0,o.kt)("p",null,"An ArgoCD Application can specify where its source templates come from by specifying the ",(0,o.kt)("inlineCode",{parentName:"p"},"spec.source.repoURL")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"spec.source.targetRevision")," fields. "),(0,o.kt)("p",null,"In the following example, an ArgoCD application called ",(0,o.kt)("inlineCode",{parentName:"p"},"cluster-claim-argocd-app")," deploys a Helm template in the ",(0,o.kt)("inlineCode",{parentName:"p"},"otp-gitops-clusters")," ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/one-touch-provisioning/otp-gitops-clusters"},"repository"),". The path ",(0,o.kt)("inlineCode",{parentName:"p"},"clusterclaims")," points to a ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/one-touch-provisioning/otp-gitops-clusters/tree/master/clusterclaims"},"folder")," within the ",(0,o.kt)("inlineCode",{parentName:"p"},"otp-gitops-clusters")," repository."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: argoproj.io/v1alpha1\nkind: Application\nmetadata:\n  name: cluster-claim-argocd-app\n  annotations:\n    argocd.argoproj.io/sync-wave: "460"\n  labels:\n    gitops.tier.layer: clusters\n  finalizers:\n    - resources-finalizer.argocd.argoproj.io\nspec:\n  ignoreDifferences:\n    - group: hive.openshift.io\n      kind: ClusterClaim\n      jqPathExpressions:\n        - .metadata.annotations."cluster.open-cluster-management.io/createmanagedcluster"\n  syncPolicy:\n    automated:\n      prune: false\n      selfHeal: true\n    syncOptions:\n    - RespectIgnoreDifferences=true\n  destination:\n    namespace: openshift-gitops\n    server: https://kubernetes.default.svc\n  project: clusters\n  // highlight-start\n  source:\n    path: clusterclaims\n    repoURL: \'https://github.com/one-touch-provisioning/otp-gitops-clusters.git\'\n  // highlight-end\n    helm:\n      values: |\n        clusterClaimName: cluster-claim-name\n        clusterPoolName: cluster-pool-name\n')),(0,o.kt)("h2",{id:"appproject"},"AppProject"),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://argo-cd.readthedocs.io/en/stable/user-guide/projects/"},"An ArgoCD AppProject")," provides a logical grouping of applications. It restricts what may be deployed, where the apps could be deployed, what kinds of objects may or may not be deployed. By default, an ArgoCD application belongs to a ",(0,o.kt)("inlineCode",{parentName:"p"},"default")," AppProject, which is created automatically and it permits deployment from any source repos, to any clusters, and all resource kinds."),(0,o.kt)("p",null,"An ArgoCD application is assigned to an AppProject in the ",(0,o.kt)("inlineCode",{parentName:"p"},"spec.project")," field."),(0,o.kt)("p",null,"In this pattern, there are 5 AppProjects, each map to a corresponding ArgoCD application: ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/one-touch-provisioning/otp-gitops/blob/master/0-bootstrap/hub/1-infra/1-infra.yaml"},(0,o.kt)("inlineCode",{parentName:"a"},"infra")),", ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/one-touch-provisioning/otp-gitops/blob/master/0-bootstrap/hub/2-services/2-services.yaml"},(0,o.kt)("inlineCode",{parentName:"a"},"services")),", ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/one-touch-provisioning/otp-gitops/blob/master/0-bootstrap/hub/3-policies/3-policies.yaml"},(0,o.kt)("inlineCode",{parentName:"a"},"policies")),", ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/one-touch-provisioning/otp-gitops/blob/master/0-bootstrap/hub/4-clusters/4-clusters.yaml"},(0,o.kt)("inlineCode",{parentName:"a"},"clusters")),", and ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/one-touch-provisioning/otp-gitops/blob/master/0-bootstrap/hub/5-apps/5-apps.yaml"},(0,o.kt)("inlineCode",{parentName:"a"},"apps")),"."),(0,o.kt)("p",null,"When a new resource is added to a layer, its kind, apiGroup and the intended namespace must be added to the the corresponding ",(0,o.kt)("inlineCode",{parentName:"p"},"spec.clusterResourceWhitelist")," field:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"---\napiVersion: argoproj.io/v1alpha1\nkind: AppProject\nmetadata:\n  # Metadata fields\nspec:\n  # Other spec fields\n  // highlight-start\n  destinations:\n  - namespace: applicable-namespaces\n    server: https://kubernetes.default.svc\n  // highlight-end\n  # Other spec fields\n  // highlight-start\n  clusterResourceWhitelist:\n  - group: apiGroup\n    kind: crd-kind\n  // highlight-end\n  # Other allowed cluster resources\n")),(0,o.kt)("h2",{id:"applicationset"},"ApplicationSet"),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://argocd-applicationset.readthedocs.io/en/stable/"},"ArgoCD ApplicationSet")," is a separate controller in the ArgoCD project. It is deployed by default with OpenShift GitOps. ",(0,o.kt)("inlineCode",{parentName:"p"},"ApplicationSet")," is similar to Red Had Advanced Cluster Management, in that it allows a single application to be deployed to multiple clusters. ",(0,o.kt)("inlineCode",{parentName:"p"},"ApplicationSet"),", however, also allows you to define deployment targets based on ",(0,o.kt)("a",{parentName:"p",href:"https://argocd-applicationset.readthedocs.io/en/stable/Generators/"},"generators")," instead of just using cluster selectors like RHACM's ",(0,o.kt)("a",{parentName:"p",href:"https://access.redhat.com/documentation/en-us/red_hat_advanced_cluster_management_for_kubernetes/2.7/html/applications/managing-applications#placement-rule-yaml-structure"},"PlacementRule"),"."),(0,o.kt)("p",null,"In OTP, ",(0,o.kt)("inlineCode",{parentName:"p"},"ApplicationSet"),"s are used to dynamically provision machine pools in different cloud vendors while re-using the existing templates provided in ",(0,o.kt)("inlineCode",{parentName:"p"},"otp-infra"),". In the example below, we're using the ",(0,o.kt)("a",{parentName:"p",href:"https://argocd-applicationset.readthedocs.io/en/stable/Generators-Cluster/"},"cluster generator")," to select managed clusters on Azure, and dynamically creating the ArgoCD applications using the cluster generator's outputs."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: argoproj.io/v1alpha1\nkind: ApplicationSet\nmetadata:\n  name: azure-machinepools\nspec:\n  // highlight-start\n  generators:\n  - clusters:\n      selector:\n        matchLabels:\n          apps.open-cluster-management.io/acm-cluster: \"true\"\n          hive.openshift.io/cluster-platform: azure\n  // highlight-end\n  template:\n    metadata:\n      name: '{{name}}-storage'\n    spec:\n      project: clusters\n      source:\n        # infra repo must be added to the sourceRepos in ArgoCD AppProject\n        repoURL: https://github.com/otp-itz/otp-gitops-infra.git\n        path: machinepools\n        helm:\n          values: |\n            cloudProvider:\n              name: \"azure\" # aws, azure, ibmcloud or vsphere\n              managed: false # for roks, aro, rosa set to true\n            cloud:\n              clusterName: {{ name }}\n      destination:\n        server: 'https://kubernetes.default.svc'\n        namespace: '{{ name }}'\n      syncPolicy:\n        automated:\n          prune: true\n          selfHeal: true\n")))}d.isMDXComponent=!0}}]);